<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Test - CollectPro</title>
    <link rel="manifest" href="site.webmanifest">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #results {
            margin-top: 20px;
            text-align: left;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>PWA Installation Test</h1>
    
    <button onclick="testServiceWorker()">Test Service Worker</button>
    <button onclick="testManifest()">Test Manifest</button>
    <button onclick="testInstallPrompt()">Test Install Prompt</button>
    <button onclick="resetPWAState()">Reset PWA State</button>
    <button onclick="triggerInstall()">Trigger Install</button>
    
    <div id="results"></div>

    <script src="/src/main.js"></script>
    <script src="/src/install-prompt.js"></script>
    <script src="/src/install-app-btn.js"></script>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message) {
            console.log(message);
            results.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }
        
        async function testServiceWorker() {
            log('=== Testing Service Worker ===');
            
            if ('serviceWorker' in navigator) {
                log('âœ… Service Worker supported');
                
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        log('âœ… Service Worker registered: ' + registration.scope);
                        log('Active: ' + !!registration.active);
                        log('Installing: ' + !!registration.installing);
                        log('Waiting: ' + !!registration.waiting);
                        
                        if (registration.active) {
                            log('Service Worker state: ' + registration.active.state);
                        }
                    } else {
                        log('âŒ No Service Worker registration found');
                    }
                } catch (error) {
                    log('âŒ Error checking Service Worker: ' + error.message);
                }
            } else {
                log('âŒ Service Worker not supported');
            }
        }
        
        async function testManifest() {
            log('=== Testing Manifest ===');
            
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                log('âœ… Manifest link found: ' + manifestLink.href);
                
                try {
                    const response = await fetch(manifestLink.href);
                    if (response.ok) {
                        const manifest = await response.json();
                        log('âœ… Manifest loaded successfully');
                        log('Name: ' + manifest.name);
                        log('Display: ' + manifest.display);
                        log('Icons: ' + manifest.icons.length);
                    } else {
                        log('âŒ Failed to load manifest: ' + response.status);
                    }
                } catch (error) {
                    log('âŒ Error loading manifest: ' + error.message);
                }
            } else {
                log('âŒ No manifest link found');
            }
        }
        
        function testInstallPrompt() {
            log('=== Testing Install Prompt ===');
            
            if ('beforeinstallprompt' in window) {
                log('âœ… beforeinstallprompt event supported');
            } else {
                log('âŒ beforeinstallprompt event NOT supported');
            }
            
            log('Deferred prompt available: ' + !!window.deferredPrompt);
            
            if (window.installPromptUtils) {
                window.installPromptUtils.debug();
                window.installPromptUtils.checkPWA();
            }
        }
        
        function resetPWAState() {
            log('=== Resetting PWA State ===');
            
            if (window.installPromptUtils) {
                window.installPromptUtils.reset();
            }
            
            localStorage.removeItem('installPromptDismissed');
            localStorage.removeItem('appInstalled');
            
            log('âœ… PWA state reset');
        }
        
        async function triggerInstall() {
            log('=== Triggering Install ===');
            
            if (window.deferredPrompt) {
                log('âœ… Deferred prompt available, triggering...');
                try {
                    window.deferredPrompt.prompt();
                    const { outcome } = await window.deferredPrompt.userChoice;
                    log('Install outcome: ' + outcome);
                    
                    if (outcome === 'accepted') {
                        localStorage.setItem('appInstalled', 'true');
                        log('âœ… App installation accepted');
                    } else {
                        log('âŒ App installation rejected');
                    }
                    
                    window.deferredPrompt = null;
                } catch (error) {
                    log('âŒ Error triggering install: ' + error.message);
                }
            } else {
                log('âŒ No deferred prompt available');
                
                // Try to manually trigger the event
                log('Trying to trigger beforeinstallprompt event...');
                
                // This won't work but shows the attempt
                const event = new Event('beforeinstallprompt');
                window.dispatchEvent(event);
            }
        }
        
        // Listen for events
        window.addEventListener('beforeinstallprompt', (e) => {
            log('ðŸŽ‰ beforeinstallprompt event fired!');
            e.preventDefault();
        });
        
        window.addEventListener('appinstalled', () => {
            log('ðŸŽ‰ appinstalled event fired!');
        });
        
        // Auto-run tests
        setTimeout(() => {
            testServiceWorker();
            testManifest();
            testInstallPrompt();
        }, 1000);
    </script>
</body>
</html>
