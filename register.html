<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#007965" />
  <title>إنشاء حساب جديد - CollectPro</title>
  <link rel="apple-touch-icon" href="public/logoapp.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="sidebar.css" />
  <link rel="stylesheet" href="login.css" />
  <meta name="csrf-token" content="YOUR_CSRF_TOKEN_HERE">
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <!-- شعار التطبيق -->
      <div class="logo-container">
        <img src="public/logo-momkn.png" alt="شعار ممكن" class="logo" />
        <h1 class="app-name">CollectPro</h1>
        <p class="subtitle">نظام إدارة التحصيلات المتقدم</p>
      </div>

      <!-- رسائل التنبيه -->
      <div id="alert-container" class="alert-container"></div>

      <!-- نموذج إنشاء حساب جديد -->
      <form id="register-form" class="login-form">
        <div class="form-group">
          <label for="full-name">الاسم الكامل</label>
          <div class="input-container">
            <i class="fas fa-user input-icon"></i>
            <input type="text" id="full-name" name="full-name" placeholder="أدخل اسمك الكامل" required />
          </div>
          <span class="error-message" id="full-name-error"></span>
        </div>

        <div class="form-group">
          <label for="email">البريد الإلكتروني</label>
          <div class="input-container">
            <i class="fas fa-envelope input-icon"></i>
            <input type="email" id="email" name="email" placeholder="أدخل بريدك الإلكتروني" required />
          </div>
          <span class="error-message" id="email-error"></span>
        </div>

        <div class="form-group">
          <label for="password">كلمة المرور</label>
          <div class="input-container">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="password" name="password" placeholder="أدخل كلمة المرور" required />
            <button type="button" id="toggle-password" class="toggle-password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <span class="error-message" id="password-error"></span>
          <div class="password-strength">
            <div class="strength-meter">
              <div class="strength-meter-fill"></div>
            </div>
            <span class="strength-text">قوة كلمة المرور</span>
          </div>
        </div>

        <div class="form-group">
          <label for="confirm-password">تأكيد كلمة المرور</label>
          <div class="input-container">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="confirm-password" name="confirm-password" placeholder="أعد إدخال كلمة المرور" required />
            <button type="button" id="toggle-confirm-password" class="toggle-password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <span class="error-message" id="confirm-password-error"></span>
        </div>

        <div class="form-group">
          <label for="phone">رقم الهاتف (اختياري)</label>
          <div class="input-container">
            <i class="fas fa-phone input-icon"></i>
            <input type="tel" id="phone" name="phone" placeholder="أدخل رقم هاتفك" />
          </div>
        </div>

        <div class="form-group terms">
          <input type="checkbox" id="accept-terms" required />
          <label for="accept-terms">أوافق على <a href="#">الشروط والأحكام</a> و<a href="#">سياسة الخصوصية</a></label>
          <span class="error-message" id="accept-terms-error"></span>
        </div>

        <button type="submit" class="login-btn">
          <span class="btn-text">إنشاء حساب</span>
          <i class="fas fa-spinner fa-spin spinner"></i>
        </button>

        <div class="divider">
          <span>أو</span>
        </div>

        <button type="button" id="google-register" class="google-login-btn">
          <i class="fab fa-google"></i>
          <span>إنشاء حساب بحساب Google</span>
        </button>

        <div class="signup-link">
          <p>لديك حساب بالفعل؟ <a href="login.html">تسجيل الدخول</a></p>
        </div>
      </form>
    </div>
  </div>

  <!-- نموذج التحقق بخطوتين -->
  <div id="two-factor-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>التحقق من البريد الإلكتروني</h2>
        <button class="close-modal">&times;</button>
      </div>
      <p class="modal-description">لقد أرسلنا رمز التحقق إلى بريدك الإلكتروني. الرجاء إدخاله أدناه.</p>
      <form id="two-factor-form">
        <div class="form-group">
          <label for="verification-code">رمز التحقق</label>
          <div class="input-container">
            <i class="fas fa-shield-alt input-icon"></i>
            <input type="text" id="verification-code" placeholder="أدخل رمز التحقق" maxlength="6" required />
          </div>
          <span class="error-message" id="verification-code-error"></span>
        </div>

        <div class="resend-code">
          <p>لم تستلم الرمز؟ <a href="#" id="resend-code-link">إعادة إرسال</a></p>
          <p id="resend-timer"></p>
        </div>

        <button type="submit" class="submit-btn">تحقق</button>
      </form>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="supabase-loader.js"></script>
  <script src="auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // عناصر النموذج
      const registerForm = document.getElementById('register-form');
      const fullNameInput = document.getElementById('full-name');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const phoneInput = document.getElementById('phone');
      const acceptTermsInput = document.getElementById('accept-terms');
      const togglePasswordBtn = document.getElementById('toggle-password');
      const toggleConfirmPasswordBtn = document.getElementById('toggle-confirm-password');
      const googleRegisterBtn = document.getElementById('google-register');

      // عناصر نموذج التحقق
      const twoFactorModal = document.getElementById('two-factor-modal');
      const twoFactorForm = document.getElementById('two-factor-form');
      const verificationCodeInput = document.getElementById('verification-code');
      const resendCodeLink = document.getElementById('resend-code-link');
      const resendTimer = document.getElementById('resend-timer');
      const closeModalBtns = document.querySelectorAll('.close-modal');

      // إظهار/إخفاء كلمة المرور
      togglePasswordBtn.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });

      // إظهار/إخفاء تأكيد كلمة المرور
      toggleConfirmPasswordBtn.addEventListener('click', () => {
        const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPasswordInput.setAttribute('type', type);
        toggleConfirmPasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });

      // التحقق من قوة كلمة المرور
      passwordInput.addEventListener('input', () => {
        const password = passwordInput.value;
        const strengthMeter = document.querySelector('.strength-meter-fill');
        const strengthText = document.querySelector('.strength-text');

        // حساب قوة كلمة المرور
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[A-Z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        if (password.match(/[$@#&!]+/)) strength++;

        // تحديث مؤشر القوة
        strengthMeter.style.width = `${strength * 20}%`;

        // تحديث نص القوة
        if (strength < 2) {
          strengthMeter.style.backgroundColor = '#ff4d4d';
          strengthText.textContent = 'ضعيفة';
        } else if (strength < 4) {
          strengthMeter.style.backgroundColor = '#ffa64d';
          strengthText.textContent = 'متوسطة';
        } else {
          strengthMeter.style.backgroundColor = '#4dff4d';
          strengthText.textContent = 'قوية';
        }
      });

      // إرسال نموذج إنشاء الحساب
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const fullName = fullNameInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const phone = phoneInput.value.trim();
        const acceptTerms = acceptTermsInput.checked;

        // التحقق من صحة البيانات
        if (!fullName) {
          showAlert('الاسم الكامل مطلوب', 'error');
          return;
        }

        if (!email) {
          showAlert('البريد الإلكتروني مطلوب', 'error');
          return;
        }

        if (!password) {
          showAlert('كلمة المرور مطلوبة', 'error');
          return;
        }

        if (password !== confirmPassword) {
          showAlert('كلمتا المرور غير متطابقتين', 'error');
          return;
        }

        if (password.length < 8) {
          showAlert('كلمة المرور يجب أن تكون 8 أحرف على الأقل', 'error');
          return;
        }

        if (!acceptTerms) {
          showAlert('يجب الموافقة على الشروط والأحكام وسياسة الخصوصية', 'error');
          return;
        }

        // تعطيل زر الإرسال وإظهار مؤشر التحميل
        const submitBtn = registerForm.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const spinner = submitBtn.querySelector('.spinner');

        submitBtn.disabled = true;
        btnText.textContent = 'جاري إنشاء الحساب...';
        spinner.style.display = 'inline-block';

        try {
          const config = window.AppConfig || {};
          const supabaseUrl = config.supabase?.url;
          const supabaseAnonKey = config.supabase?.anonKey;

          if (!supabaseUrl || !supabaseAnonKey) {
            throw new Error('إعدادات Supabase غير مكتملة');
          }

          // إنشاء عميل Supabase
          const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

          // إنشاء حساب جديد
          const { data, error } = await supabaseClient.auth.signUp({
            email,
            password,
            options: {
              data: {
                full_name: fullName,
                phone: phone || ''
              }
            }
          });

          if (error) {
            throw error;
          }

          // إنشاء سجل المستخدم في جدول users
          if (data.user) {
            const { error: insertError } = await supabaseClient
              .from('users')
              .insert([{
                id: data.user.id,
                email: data.user.email,
                full_name: fullName,
                phone: phone || '',
                is_verified: false,
                is_admin: false
              }]);

            if (insertError) {
              console.error('Error creating user record:', insertError);
            }
          }

          showAlert('تم إنشاء الحساب بنجاح، يرجى التحقق من بريدك الإلكتروني', 'success');

          // إعادة توجيه المستخدم إلى صفحة تسجيل الدخول بعد ثانيتين
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);

        } catch (error) {
          console.error('Registration error:', error);
          showAlert(error.message || 'حدث خطأ أثناء إنشاء الحساب', 'error');

          // إعادة تفعيل زر الإرسال
          submitBtn.disabled = false;
          btnText.textContent = 'إنشاء حساب';
          spinner.style.display = 'none';
        }
      });

      // إنشاء حساب باستخدام Google
      googleRegisterBtn.addEventListener('click', async () => {
        try {
          const config = window.AppConfig || {};
          const supabaseUrl = config.supabase?.url;
          const supabaseAnonKey = config.supabase?.anonKey;

          if (!supabaseUrl || !supabaseAnonKey) {
            throw new Error('إعدادات Supabase غير مكتملة');
          }

          // إنشاء عميل Supabase
          const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

          // تسجيل الدخول باستخدام Google
          const { error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.origin
            }
          });

          if (error) {
            throw error;
          }

        } catch (error) {
          console.error('Google registration error:', error);
          showAlert(error.message || 'حدث خطأ أثناء التسجيل باستخدام Google', 'error');
        }
      });

      // إغلاق النوافذ المنبثقة
      closeModalBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.modal').style.display = 'none';
        });
      });

      // إغلاق النافذة عند النقر خارجها
      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      // إرسال نموذج التحقق
      twoFactorForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const verificationCode = verificationCodeInput.value.trim();

        if (!verificationCode) {
          showAlert('رمز التحقق مطلوب', 'error');
          return;
        }

        // تعطيل زر الإرسال
        const submitBtn = twoFactorForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري التحقق...';

        try {
          // هنا يمكن إضافة منطق التحقق من الرمز
          showAlert('تم التحقق بنجاح', 'success');

          // إغلاق النافذة المنبثقة
          twoFactorModal.style.display = 'none';

          // إعادة توجيه المستخدم إلى الصفحة الرئيسية
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1000);

        } catch (error) {
          console.error('Verification error:', error);
          showAlert(error.message || 'حدث خطأ أثناء التحقق', 'error');

          // إعادة تفعيل زر الإرسال
          submitBtn.disabled = false;
          submitBtn.textContent = 'تحقق';
        }
      });

      // إعادة إرسال رمز التحقق
      resendCodeLink.addEventListener('click', async (e) => {
        e.preventDefault();

        // تعطيل رابط إعادة الإرسال
        resendCodeLink.disabled = true;

        try {
          // هنا يمكن إضافة منطق إعادة إرسال الرمز
          showAlert('تم إعادة إرسال رمز التحقق', 'success');

          // بدء العد التنازلي
          let countdown = 60;
          resendTimer.textContent = `يمكنك إعادة الإرسال بعد ${countdown} ثانية`;

          const countdownInterval = setInterval(() => {
            countdown--;
            resendTimer.textContent = `يمكنك إعادة الإرسال بعد ${countdown} ثانية`;

            if (countdown <= 0) {
              clearInterval(countdownInterval);
              resendTimer.textContent = '';
              resendCodeLink.disabled = false;
            }
          }, 1000);

        } catch (error) {
          console.error('Resend code error:', error);
          showAlert(error.message || 'حدث خطأ أثناء إعادة إرسال الرمز', 'error');

          // إعادة تفعيل رابط إعادة الإرسال
          resendCodeLink.disabled = false;
        }
      });
    });

    // دالة لعرض التنبيهات
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <div class="alert-content">
          <span>${message}</span>
          <button class="alert-close">&times;</button>
        </div>
      `;

      alertContainer.appendChild(alert);

      // إضافة مستمع حدث لزر الإغلاق
      const closeBtn = alert.querySelector('.alert-close');
      closeBtn.addEventListener('click', () => {
        alert.remove();
      });

      // إخفاء التنبيه تلقائيًا بعد 5 ثوانٍ
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
  </script>
</body>
</html>






