<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#007965" />
  <title>إعادة تعيين كلمة المرور - CollectPro</title>
  <link rel="apple-touch-icon" href="public/logo-momkn.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="sidebar.css" />
  <link rel="stylesheet" href="login.css" />
  <meta name="csrf-token" content="YOUR_CSRF_TOKEN_HERE">
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <!-- شعار التطبيق -->
      <div class="logo-container">
        <img src="public/logo-momkn.png" alt="شعار ممكن" class="logo" />
        <h1 class="app-name">CollectPro</h1>
        <p class="subtitle">نظام إدارة التحصيلات المتقدم</p>
      </div>

      <!-- رسائل التنبيه -->
      <div id="alert-container" class="alert-container"></div>

      <!-- نموذج إعادة تعيين كلمة المرور -->
      <form id="reset-password-form" class="login-form">
        <div class="form-group">
          <label for="new-password">كلمة المرور الجديدة</label>
          <div class="input-container">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="new-password" name="new-password" placeholder="أدخل كلمة المرور الجديدة" required />
            <button type="button" id="toggle-new-password" class="toggle-password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <span class="error-message" id="new-password-error"></span>
          <div class="password-strength">
            <div class="strength-meter">
              <div class="strength-meter-fill"></div>
            </div>
            <span class="strength-text">قوة كلمة المرور</span>
          </div>
        </div>

        <div class="form-group">
          <label for="confirm-password">تأكيد كلمة المرور الجديدة</label>
          <div class="input-container">
            <i class="fas fa-lock input-icon"></i>
            <input type="password" id="confirm-password" name="confirm-password" placeholder="أعد إدخال كلمة المرور الجديدة" required />
            <button type="button" id="toggle-confirm-password" class="toggle-password">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <span class="error-message" id="confirm-password-error"></span>
        </div>

        <button type="submit" class="login-btn">
          <span class="btn-text">تحديث كلمة المرور</span>
          <i class="fas fa-spinner fa-spin spinner"></i>
        </button>

        <div class="back-to-login">
          <p>تذكرت كلمة المرور؟ <a href="login.html">تسجيل الدخول</a></p>
        </div>
      </form>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="supabase-loader.js"></script>
  <script src="auth.js"></script>
  <script>
    // استخراج رمز إعادة التعيين من الرابط
    function getResetTokenFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token');
    }

    // التحقق من وجود رمز إعادة التعيين
    document.addEventListener('DOMContentLoaded', () => {
      const resetToken = getResetTokenFromURL();

      if (!resetToken) {
        showAlert('رابط إعادة تعيين كلمة المرور غير صالح أو منتهي الصلاحية', 'error');
        document.getElementById('reset-password-form').style.display = 'none';
        return;
      }

      // إعداد نموذج إعادة تعيين كلمة المرور
      const resetPasswordForm = document.getElementById('reset-password-form');
      const newPasswordInput = document.getElementById('new-password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const toggleNewPasswordBtn = document.getElementById('toggle-new-password');
      const toggleConfirmPasswordBtn = document.getElementById('toggle-confirm-password');

      // إظهار/إخفاء كلمة المرور الجديدة
      toggleNewPasswordBtn.addEventListener('click', () => {
        const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        newPasswordInput.setAttribute('type', type);
        toggleNewPasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });

      // إظهار/إخفاء تأكيد كلمة المرور
      toggleConfirmPasswordBtn.addEventListener('click', () => {
        const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPasswordInput.setAttribute('type', type);
        toggleConfirmPasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });

      // التحقق من قوة كلمة المرور
      newPasswordInput.addEventListener('input', () => {
        const password = newPasswordInput.value;
        const strengthMeter = document.querySelector('.strength-meter-fill');
        const strengthText = document.querySelector('.strength-text');

        // حساب قوة كلمة المرور
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]+/)) strength++;
        if (password.match(/[A-Z]+/)) strength++;
        if (password.match(/[0-9]+/)) strength++;
        if (password.match(/[$@#&!]+/)) strength++;

        // تحديث مؤشر القوة
        strengthMeter.style.width = `${strength * 20}%`;

        // تحديث نص القوة
        if (strength < 2) {
          strengthMeter.style.backgroundColor = '#ff4d4d';
          strengthText.textContent = 'ضعيفة';
        } else if (strength < 4) {
          strengthMeter.style.backgroundColor = '#ffa64d';
          strengthText.textContent = 'متوسطة';
        } else {
          strengthMeter.style.backgroundColor = '#4dff4d';
          strengthText.textContent = 'قوية';
        }
      });

      // إرسال نموذج إعادة تعيين كلمة المرور
      resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // التحقق من تطابق كلمتي المرور
        if (newPassword !== confirmPassword) {
          showAlert('كلمتا المرور غير متطابقتين', 'error');
          return;
        }

        // التحقق من قوة كلمة المرور
        if (newPassword.length < 8) {
          showAlert('كلمة المرور يجب أن تكون 8 أحرف على الأقل', 'error');
          return;
        }

        // تعطيل زر الإرسال وإظهار مؤشر التحميل
        const submitBtn = resetPasswordForm.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const spinner = submitBtn.querySelector('.spinner');

        submitBtn.disabled = true;
        btnText.textContent = 'جاري التحديث...';
        spinner.style.display = 'inline-block';

        try {
          const config = window.AppConfig || {};
          const supabaseUrl = config.supabase?.url;
          const supabaseAnonKey = config.supabase?.anonKey;

          if (!supabaseUrl || !supabaseAnonKey) {
            throw new Error('إعدادات Supabase غير مكتملة');
          }

          // إنشاء عميل Supabase
          const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

          // تحديث كلمة المرور
          const { error } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (error) {
            throw error;
          }

          showAlert('تم تحديث كلمة المرور بنجاح، جاري إعادة التوجيه...', 'success');

          // إعادة التوجيه إلى صفحة تسجيل الدخول بعد ثانيتين
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);

        } catch (error) {
          console.error('Error resetting password:', error);
          showAlert(error.message || 'حدث خطأ أثناء تحديث كلمة المرور', 'error');

          // إعادة تفعيل زر الإرسال
          submitBtn.disabled = false;
          btnText.textContent = 'تحديث كلمة المرور';
          spinner.style.display = 'none';
        }
      });
    });

    // دالة لعرض التنبيهات
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.innerHTML = `
        <div class="alert-content">
          <span>${message}</span>
          <button class="alert-close">&times;</button>
        </div>
      `;

      alertContainer.appendChild(alert);

      // إضافة مستمع حدث لزر الإغلاق
      const closeBtn = alert.querySelector('.alert-close');
      closeBtn.addEventListener('click', () => {
        alert.remove();
      });

      // إخفاء التنبيه تلقائيًا بعد 5 ثوانٍ
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }
  </script>
</body>
</html>
