// Global error handlers
window.onerror = function(message, source, lineno, colno, error) {
  console.error("An unhandled error occurred:", {
    message: message,
    source: source,
    lineno: lineno,
    colno: colno,
    error: error
  });
  // Here you could send the error to a logging service
};

window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled promise rejection:', {
    reason: event.reason
  });
  // Here you could send the error to a logging service
});

// Register Service Worker for PWA functionality
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('ğŸ“± Service Worker registered successfully:', registration.scope);

        // Handle updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New version available
              console.log('ğŸ“± New version available. Please refresh to update.');
              // You could show a notification to the user here
            }
          });
        });
      })
      .catch((error) => {
        console.error('ğŸ“± Service Worker registration failed:', error);
      });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ”§ Initializing login page...');

  const googleLoginBtn = document.getElementById('google-login-btn');
  const shareAppBtn = document.getElementById('share-app-btn');

  // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ù„Ù…Ù†Ø¹ Ø§Ù„ÙˆÙ…ÙŠØ¶
  googleLoginBtn.style.display = 'none';

  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙˆØ±Ù‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù…Ø«Ù„ ÙØªØ­ Ø§Ø®ØªØµØ§Ø± PWA Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
  (async () => {
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) {
        console.error('âŒ Error getting current session:', error);
      } else if (session) {
        console.log('âœ… Active session found via getSession, syncing profile and redirecting...');
        await syncUserProfile(session.user);
        redirectUser(session.user);
        return; // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©
      } else {
        console.log('No active session from getSession, waiting for onAuthStateChange...');
      }
    } catch (err) {
      console.error('âŒ getSession threw an error:', err);
    }
  })();

  // Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø²Ø± Ù…Ø®ÙÙŠÙ‹Ø§ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØµÙ„ Ø£ÙŠ Ø­Ø¯Ø« Ù…Ù† Supabase (Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
  setTimeout(() => {
    if (googleLoginBtn && googleLoginBtn.style.display === 'none') {
      console.warn('Auth state did not respond in time. Showing login button fallback.');
      googleLoginBtn.style.display = 'flex';
    }
  }, 4000);

  // onAuthStateChange Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„Ù„Ø­Ù‚ÙŠÙ‚Ø©
  supabase.auth.onAuthStateChange(async (_event, session) => {
    // ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ¹Ù†Ø¯Ù…Ø§ ØªØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©.
    if (session) {
      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡.
      console.log('âœ… Active session found, syncing profile...');
      await syncUserProfile(session.user);
      console.log('âœ… Profile synced, redirecting...');
      redirectUser(session.user);
    } else {
      // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡.
      console.log('No active session. Showing login UI.');
      // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø©
      googleLoginBtn.style.display = 'flex'; 
    }
  });

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  googleLoginBtn.addEventListener('click', async () => {
    console.log('ğŸ”§ Google login button clicked');
    googleLoginBtn.disabled = true;
    googleLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';

    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        queryParams: {
          prompt: 'select_account' // ÙŠØ¬Ø¨Ø± Ø¬ÙˆØ¬Ù„ ÙŠØ³Ø£Ù„Ùƒ ØªØ®ØªØ§Ø± Ø­Ø³Ø§Ø¨ Ù…Ù† Ø¬Ø¯ÙŠØ¯
        }
      }
    });

    if (error) {
      console.error('âŒ Error initiating Google login:', error.message);
      googleLoginBtn.disabled = false;
      googleLoginBtn.innerHTML = '<i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„';
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
  });

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
  if (shareAppBtn) {
    shareAppBtn.addEventListener('click', async () => {
      console.log('ğŸ”§ Share app button clicked');
      
      const shareData = {
        title: 'CollectPro - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…',
        text: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­ØµÙŠÙ„Ø§Øª ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
        url: window.location.href
      };

      try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Share API Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¯Ø¹ÙˆÙ…Ø©
        if (navigator.share) {
          await navigator.share(shareData);
          console.log('âœ… App shared successfully');
        } else {
          // Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… Web Share API
          await fallbackShare(shareData);
        }
      } catch (error) {
        console.error('âŒ Error sharing app:', error);
        if (error.name !== 'AbortError') {
          showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', 'danger');
        }
      }
    });
  } else {
    console.warn('Share app button not found');
  }
});

/**
 * Fallback share function for browsers that don't support Web Share API
 * @param {Object} shareData - The share data object
 */
async function fallbackShare(shareData) {
  try {
    // Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
    await navigator.clipboard.writeText(shareData.url);
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
    showAlert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ø§Ù„Ø¢Ù†.', 'success');
    console.log('âœ… Link copied to clipboard as fallback');
  } catch (clipboardError) {
    // Ø¥Ø°Ø§ ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø­Ø§ÙØ¸Ø©ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
    const message = `Ø´Ø§Ø±Ùƒ ØªØ·Ø¨ÙŠÙ‚ CollectPro:\n\n${shareData.title}\n${shareData.text}\n\nØ§Ù„Ø±Ø§Ø¨Ø·: ${shareData.url}`;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content">
        <h3>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
        <p>${shareData.title}</p>
        <p>${shareData.text}</p>
        <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; direction: ltr; font-family: monospace; word-break: break-all; margin: 10px 0;">
          ${shareData.url}
        </div>
        <div class="modal-buttons">
          <button id="copyLinkBtn" class="confirm-btn">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
          <button id="closeModalBtn" class="cancel-btn">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('copyLinkBtn').onclick = async () => {
      try {
        await navigator.clipboard.writeText(shareData.url);
        showAlert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        modal.remove();
      } catch (error) {
        console.error('Failed to copy link:', error);
        showAlert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹', 'danger');
      }
    };
    
    document.getElementById('closeModalBtn').onclick = () => {
      modal.remove();
    };
    
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    };
    
    console.log('âœ… Fallback share modal displayed');
  }
}

/**
 * Show alert message (simple implementation for login page)
 * @param {string} message - The message to display
 * @param {string} type - The type of alert (info, success, danger, warning)
 */
function showAlert(message, type = 'info') {
  const alertContainer = document.getElementById('alert-container');
  if (!alertContainer) {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø­Ø§ÙˆÙŠØ© ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… alert Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    alert(message);
    return;
  }

  const alert = document.createElement('div');
  alert.className = `alert alert-${type} show`;

  let icon = 'fa-info-circle';
  if (type === 'success') icon = 'fa-check-circle';
  if (type === 'danger') icon = 'fa-exclamation-circle';
  if (type === 'warning') icon = 'fa-exclamation-triangle';

  alert.innerHTML = `<i class="fas ${icon}"></i> ${message}`;

  alertContainer.appendChild(alert);

  setTimeout(() => {
    alert.classList.remove('show');
    setTimeout(() => alert.remove(), 500);
  }, 5000);
}

/**
 * Redirects the user based on their role.
 * @param {Object} user The Supabase user object.
 */
/**
 * Syncs the user profile to public.users table if not exists.
 * @param {Object} user The Supabase user object.
 */
async function syncUserProfile(user) {
  try {
    const { data, error } = await supabase.from('users').select('id').eq('id', user.id).single();

    if (error && error.code === 'PGRST116') {
      // User not found, insert new record
      const full_name = user.user_metadata?.full_name || user.email;
      const { error: insertError } = await supabase.from('users').insert({
        id: user.id,
        full_name: full_name,
        email: user.email,
        password_hash: ''
      });

      if (insertError) {
        console.error('âŒ Error inserting user profile:', insertError);
      } else {
        console.log('âœ… User profile synced successfully');
      }
    } else if (data) {
      console.log('âœ… User profile already exists');
    } else {
      console.error('âŒ Error checking user profile:', error);
    }
  } catch (err) {
    console.error('âŒ Sync user profile error:', err);
  }
}

/**
 * Redirects the user based on their role.
 * @param {Object} user The Supabase user object.
 */
async function redirectUser(user) {
    if (!user) return;

    console.log('ğŸ” Checking user role for redirection. User ID:', user.id);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const adminEmails = ['emontal.33@gmail.com']; // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†
    const isAdmin = adminEmails.includes(user.email);

    if (isAdmin) {
      console.log('ğŸ‘‘ Admin user detected. Redirecting to data entry page.');
      window.location.href = 'dashboard.html';
    } else {
      // Check for last page
      const lastPage = localStorage.getItem('lastPage');
      if (lastPage) {
        console.log('ğŸ‘¤ Regular user detected. Redirecting to last page:', lastPage);
        window.location.href = lastPage;
      } else {
        console.log('ğŸ‘¤ Regular user detected. Redirecting to dashboard page.');
        window.location.href = 'dashboard.html';
      }
    }
}

